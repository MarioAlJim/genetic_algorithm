{% extends 'index.html' %} {% block body %}

<header>
    <div class="header-title">
        <div class="title">BiTe Playground</div>
    </div>
    <div class="container form-background">
        <div>
            <form method="POST" action="">
                {{ initialConfig.hidden_tag() }}
                <div class="combobox-container" >
                    <label for="problem" class="label-header">Problema:</label>
                    {{ initialConfig.problem(class="combo-header") }}

                    <label for="algorithm" class="label-header">Algoritmo:</label>
                    {{ initialConfig.algorithm(class="combo-header") }}
                    <div class="button-container">
                        <button type="submit" class="btn btn-primary">Aplicar</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="button-container">
            <button id="download-btn">Descargar Reporte</button>
        </div>
    </div>
</header>

<main>
    <div class="left-panel">
        <div id="configFormContainer" style="display: none;">
            <h3>Configuraciones</h3>
            <div class="form-background">
                 <form method="POST" action="" id="config-form">
                    {{ gaConfigForm.hidden_tag() }}
                    <div class="form-group">
                        {{ gaConfigForm.population_size.label(class="label-form") }}
                        {{ gaConfigForm.population_size(class="form-control", id="population_size") }}
                    </div>

                    <div class="form-group">
                        {{ gaConfigForm.generations.label(class="label-form") }}
                        {{ gaConfigForm.generations(class="form-control", id="generations") }}
                    </div>

                     <div class="form-group">
                        {{ gaConfigForm.selection_rate.label(class="label-form") }}
                        {{ gaConfigForm.selection_rate(class="form-control", id="selection_rate") }}
                    </div>

                    <div class="form-group">
                        {{ gaConfigForm.selection_type.label(class="label-form") }}
                        {{ gaConfigForm.selection_type(class="form-control", id="selection_type") }}
                    </div>

                    <div class="form-group">
                        {{ gaConfigForm.crossover_type.label(class="label-form") }}
                        {{ gaConfigForm.crossover_type(class="form-control", id="crossover_type") }}
                    </div>

                    <div class="form-group">
                        {{ gaConfigForm.mutation_rate.label(class="label-form") }}
                        {{ gaConfigForm.mutation_rate(class="form-control", id="mutation_rate") }}
                    </div>

                    <div class="form-group">
                        {{ gaConfigForm.mutation_type.label(class="label-form") }}
                        {{ gaConfigForm.mutation_type(class="form-control", id="mutation_type") }}
                    </div>

                    <button type="button" class="button btn-primary" onclick="startExecution()">Iniciar ejecución</button>

                </form>
            </div>
        </div>
    </div>

    <div class="right-panel">
        <h3>Resultados de la ejecución</h3>
        <div class="tabs-container">
            <div class="tabs-buttons"></div>
            <div class="tabs-content"></div>
        </div>
    </div>
</main>

    <script>
        function startExecution() {
            const populationSize = document.getElementById("population_size").value;
            const generations = document.getElementById("generations").value;
            const selectionRate = document.getElementById("selection_rate").value;
            const selectionType = document.getElementById("selection_type").value;
            const crossoverType = document.getElementById("crossover_type").value;
            const mutationRate = document.getElementById("mutation_rate").value;
            const mutationType = document.getElementById("mutation_type").value;

            fetch("ga/execute", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    population_size: populationSize,
                    generations: generations,
                    selection_rate: selectionRate,
                    selection_type: selectionType,
                    crossover_type: crossoverType,
                    mutation_rate: mutationRate,
                    mutation_type: mutationType
                })
            })
            .then(res => res.json())
            .then(data => {
                addChart(data);
            });
        }

        let executionCount = 1;

        function addChart(result) {
            const configData = result.config;
            const execData = result.exec_data;
            const coverageData = result.coverage_evaluation;

            const tabsButtons = document.querySelector('.tabs-buttons');
            const tabsContent = document.querySelector('.tabs-content');

            // Crear un nuevo botón de pestaña
            const tabButton = document.createElement('button');
            tabButton.textContent = `Ejecución ${executionCount}`;
            tabButton.classList.add('tab-btn');
            tabButton.dataset.tabIndex = executionCount;
            tabsButtons.appendChild(tabButton);

            // Crear el contenido de la pestaña
            const tabContent = document.createElement('div');
            tabContent.classList.add('tab-content');
            tabContent.dataset.tabIndex = executionCount;
            tabContent.style.display = 'none'; // Ocultar inicialmente

            // Contenedor superior para la tabla de configuración y gráfico
            const topContainer = document.createElement('div');
            topContainer.classList.add('top-container');

            // Contenedor de la tabla de configuración
            const configTableContainer = document.createElement('div');
            configTableContainer.classList.add('config-table-container');
            configTableContainer.appendChild(generateConfigTable(configData));

            // Contenedor del gráfico de cobertura
            const coverageChartContainer = document.createElement('div');
            coverageChartContainer.classList.add('coverage-chart-container');
            coverageChartContainer.appendChild(generateCoverageChart(coverageData));

            // Agregar elementos a la parte superior
            topContainer.appendChild(configTableContainer);
            topContainer.appendChild(coverageChartContainer);

            // Contenedor de la tabla de ejecución (debajo)
            const execTableContainer = document.createElement('div');
            execTableContainer.classList.add('exec-table-container');
            execTableContainer.appendChild(generateExecTable(execData));

            // Agregar todo al contenido de la pestaña
            tabContent.appendChild(topContainer);
            tabContent.appendChild(execTableContainer);

            tabsContent.appendChild(tabContent);

            // Activar la pestaña cuando se haga clic
            tabButton.addEventListener('click', () => {
                document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
                tabContent.style.display = 'block';
            });

            executionCount++; // Incrementar contador
        }

        function createTabContent(tabIndex, configData, execData, coverageData) {
            const tabContent = document.createElement('div');
            tabContent.classList.add('tab-content');
            tabContent.dataset.tabIndex = tabIndex;
            tabContent.style.display = 'none'; // Ocultar inicialmente

            // Contenedor para la configuración y el gráfico
            const topContainer = document.createElement('div');
            topContainer.classList.add('top-container');

            // Agregar tabla de configuración
            const configTableContainer = document.createElement('div');
            configTableContainer.classList.add('config-table-container');
            configTableContainer.appendChild(generateConfigTable(configData));

            // Agregar gráfico de cobertura
            const coverageChartContainer = document.createElement('div');
            coverageChartContainer.classList.add('coverage-chart-container');
            coverageChartContainer.appendChild(generateCoverageChart(coverageData));

            // Agregar elementos al contenedor superior
            topContainer.appendChild(configTableContainer);
            topContainer.appendChild(coverageChartContainer);

            // Contenedor para la tabla de ejecución (debajo)
            const execTableContainer = document.createElement('div');
            execTableContainer.classList.add('exec-table-container');
            execTableContainer.appendChild(generateExecTable(execData));

            // Agregar todo al tabContent
            tabContent.appendChild(topContainer);
            tabContent.appendChild(execTableContainer);

            return tabContent;
        }

                // Función para crear una tabla con `config`
        function generateConfigTable(configData) {
            const table = document.createElement('table');
            table.className = 'config-table';

            const headerRow = table.insertRow();
            headerRow.insertCell().textContent = "Configuración";
            headerRow.insertCell().textContent = "Valor";

            Object.entries(configData).forEach(([key, value]) => {
                const row = table.insertRow();
                row.insertCell().textContent = key;
                row.insertCell().textContent = value;
            });

            return table;
        }

        function generateExecTable(execData) {
            const table = document.createElement('table');
            table.className = 'exec-table';

            const headerRow = table.insertRow();
            Object.keys(execData).forEach(key => {
                const cell = headerRow.insertCell();
                cell.textContent = key;
            });

            const numRows = execData.Generation.length;
            for (let i = 0; i < numRows; i++) {
                const row = table.insertRow();
                Object.keys(execData).forEach(key => {
                    const cell = row.insertCell();
                    cell.textContent = execData[key][i];
                });
            }

            return table;
        }

        function generateCoverageChart(coverageData) {
            const container = document.createElement('div');
            container.className = 'graph';

            const canvas = document.createElement('canvas');
            container.appendChild(canvas);

            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: coverageData.map(entry => "Gen " + entry.gen),
                    datasets: [
                        {
                            label: "Fitness",
                            data: coverageData.map(entry => entry.fitness),
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: "Coverage",
                            data: coverageData.map(entry => entry.coverage),
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolución del Algoritmo'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            return container;
        }

        function toggleConfigForm() {
            var algorithm = document.querySelector('select[name="algorithm"]').value;
            var configFormContainer = document.getElementById('configFormContainer');

            // Cambiar el contenido según el algoritmo seleccionado
            if (algorithm === 'algorithm_1') {  // "Algoritmo Genético"
                configFormContainer.style.display = 'block';

                // Ejemplo: Cambiar opciones de selección
                document.getElementById('config-form').style.display = 'block';


            } else {  // Para otros algoritmos
                configFormContainer.style.display = 'none';

            }
        }
        // Llamar a la función al cargar la página para gestionar el estado inicial
        window.onload = toggleConfigForm;
    </script>
{% endblock %}